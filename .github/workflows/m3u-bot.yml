name: Auto Update M3U (Cleaned)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    environment: LS  

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download source M3U (hidden)
        run: |
          curl -L --fail "$SOURCE_M3U_URL" -o source.m3u
        env:
          SOURCE_M3U_URL: ${{ secrets.LS }}   

      - name: Clean & filter M3U (SAFE URL KEEP)
        run: |
          awk '
          BEGIN { keep=1 }

          /RANAPK/ && !/^https?:\/\// { keep=0; next }
          /JOIN TG/ { keep=0; next }
          /Telegram/ { keep=0; next }
          /t\.me/ { keep=0; next }
          /ফাইল চুরি/ { keep=0; next }
          /END____/ { keep=0; next }

          /WELCOME/ && !/^https?:\/\// { keep=0; next }
          /Welcome/ && !/^https?:\/\// { keep=0; next }
          /welcome/ && !/^https?:\/\// { keep=0; next }
          /•.*WELCOME.*•/ { keep=0; next }
          /★.*WELCOME.*★/ { keep=0; next }
          /●.*WELCOME.*●/ { keep=0; next }
          /---.*WELCOME.*---/ { keep=0; next }

          /^#EXTINF/ {
            keep=1
            if ($0 ~ /^#EXTINF:-1[[:space:]]*$/) keep=0
            if ($0 ~ /tvg-logo=.*[Ww]elcome/) keep=0
            if ($0 ~ /tvg-logo=.*[Ww]elcomes/) keep=0
            if (keep==1) print
            next
          }

          /^https?:\/\// {
            if (keep==1) print
            keep=1
            next
          }

          { if (keep==1) print }
          ' source.m3u > LIVE2.m3u

      - name: Commit and push if changed
        run: |
          git config user.name "m3u-bot"
          git config user.email "m3u-bot@users.noreply.github.com"

          git add LIVE2.m3u
          git diff --cached --quiet || git commit -m "Auto update LIVE2.m3u (cleaned safely)"
          git push
